<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <title>Smart Kitchen Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full">

<script src="//unpkg.com/alpinejs" defer></script>
<!--
  This example requires updating your template:

  ```
  <html class="h-full bg-gray-100">
  <body class="h-full">
  ```
-->
<div class="min-h-full">
  <nav class="bg-gray-800">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company">
          </div>
          <div class="hidden md:block">
            <div class="ml-10 flex items-baseline space-x-4">
              <!-- Current: "bg-gray-900 text-white", Default: "text-gray-300 hover:bg-gray-700 hover:text-white" -->
              <a href="/" class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Main</a>
              <a href="/forms" class="bg-gray-900 text-white rounded-md px-3 py-2 text-sm font-medium" aria-current="page">Forms</a>
              <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white rounded-md px-3 py-2 text-sm font-medium">Settings</a>
            </div>
          </div>
        </div>
        <div class="-mr-2 flex md:hidden">
          <!-- Mobile menu button -->
          <button type="button" class="relative inline-flex items-center justify-center rounded-md bg-gray-800 p-2 text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800" aria-controls="mobile-menu" aria-expanded="false">
            <span class="absolute -inset-0.5"></span>
            <span class="sr-only">Open main menu</span>
            <!-- Menu open: "hidden", Menu closed: "block" -->
            <svg class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
            <!-- Menu open: "block", Menu closed: "hidden" -->
            <svg class="hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile menu, show/hide based on menu state. -->
    <div class="md:hidden" id="mobile-menu">
      <div class="space-y-1 px-2 pb-3 pt-2 sm:px-3">
        <!-- Current: "bg-gray-900 text-white", Default: "text-gray-300 hover:bg-gray-700 hover:text-white" -->
        <a href="/" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Main</a>
        <a href="/forms" class="bg-gray-900 text-white block rounded-md px-3 py-2 text-base font-medium" aria-current="page">Forms</a>
        <a href="#" class="text-gray-300 hover:bg-gray-700 hover:text-white block rounded-md px-3 py-2 text-base font-medium">Settings</a>
      </div>
    </div>
  </nav>

  <header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
      <h1 class="text-3xl font-bold tracking-tight text-gray-900">Forms</h1>
    </div>
  </header>

  <main>
    <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">

      <div class="text-sm font-medium text-center text-gray-500 border-b border-gray-200 dark:text-gray-400 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px" id="forms-tabs">
        </ul>
      </div>

      <div id="form-data-table" class="flex flex-col hidden py-6">
        <div class="overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="inline-block min-w-full py-2 sm:px-6 lg:px-8">
            <div class="overflow-hidden">
              <table class="min-w-full text-left font-light">
                <thead class="border-b font-medium dark:border-neutral-500">
                  <tr id="form-data-table-header">
                    <th scope="col" class="px-6 py-4">#</th>
                    <th scope="col" class="px-6 py-4">First</th>
                    <th scope="col" class="px-6 py-4">Last</th>
                    <th scope="col" class="px-6 py-4">Handle</th>
                  </tr>
                </thead>
                <tbody id="form-data-table-body">
                  <tr class="border-b dark:border-neutral-500">
                    <td class="whitespace-nowrap px-6 py-4">1</td>
                    <td class="whitespace-nowrap px-6 py-4">Mark</td>
                    <td class="whitespace-nowrap px-6 py-4">Otto</td>
                    <td class="whitespace-nowrap px-6 py-4">@mdo</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <p id="form-data-table-no-data-sign" class="text-center font-light py-4 hidden">No data</p>
      </div>

    </div>
  </main>
</div>

<div 
  data-dial-init 
  class="fixed right-6 bottom-6 group"
  x-data="{ speed_dial_open: false }"
  @click.outside="speed_dial_open = false"
  @keyup.escape.window="speed_dial_open = false"
>
  <div 
    id="speed-dial-menu-default"
    x-cloak
    x-show="speed_dial_open"
    class="flex flex-col items-center mb-4 space-y-2"
  >
      <button id="speed-dial-menu-download-button" type="button" data-tooltip-target="tooltip-download" data-tooltip-placement="left" class="flex justify-center items-center w-[52px] h-[52px] text-gray-500 hover:text-gray-900 bg-white rounded-full border border-gray-200 dark:border-gray-600 shadow-sm dark:hover:text-white dark:text-gray-400 hover:bg-gray-50 dark:bg-gray-700 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 focus:outline-none dark:focus:ring-gray-400">
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
              <path d="M14.707 7.793a1 1 0 0 0-1.414 0L11 10.086V1.5a1 1 0 0 0-2 0v8.586L6.707 7.793a1 1 0 1 0-1.414 1.414l4 4a1 1 0 0 0 1.416 0l4-4a1 1 0 0 0-.002-1.414Z"/>
              <path d="M18 12h-2.55l-2.975 2.975a3.5 3.5 0 0 1-4.95 0L4.55 12H2a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2Zm-3 5a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/>
          </svg>
          <span class="sr-only">Download</span>
      </button>
      <div id="tooltip-download" role="tooltip" class="absolute z-10 invisible inline-block w-auto px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
          Download
          <div class="tooltip-arrow" data-popper-arrow></div>
      </div>
      <button id="speed-dial-menu-clear-button" type="button" data-tooltip-target="tooltip-copy" data-tooltip-placement="left" class="flex justify-center items-center w-[52px] h-[52px] text-gray-500 hover:text-gray-900 bg-white rounded-full border border-gray-200 dark:border-gray-600 dark:hover:text-white shadow-sm dark:text-gray-400 hover:bg-gray-50 dark:bg-gray-700 dark:hover:bg-gray-600 focus:ring-4 focus:ring-gray-300 focus:outline-none dark:focus:ring-gray-400">
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M7.26279 3.25871C7.38317 2.12953 8.33887 1.25 9.5 1.25H14.5C15.6611 1.25 16.6168 2.12953 16.7372 3.25871C17.5004 3.27425 18.1602 3.31372 18.7236 3.41721C19.4816 3.55644 20.1267 3.82168 20.6517 4.34661C21.2536 4.94853 21.5125 5.7064 21.6335 6.60651C21.75 7.47348 21.75 8.5758 21.75 9.94339V16.0531C21.75 17.4207 21.75 18.523 21.6335 19.39C21.5125 20.2901 21.2536 21.048 20.6517 21.6499C20.0497 22.2518 19.2919 22.5107 18.3918 22.6317C17.5248 22.7483 16.4225 22.7483 15.0549 22.7483H8.94513C7.57754 22.7483 6.47522 22.7483 5.60825 22.6317C4.70814 22.5107 3.95027 22.2518 3.34835 21.6499C2.74643 21.048 2.48754 20.2901 2.36652 19.39C2.24996 18.523 2.24998 17.4207 2.25 16.0531V9.94339C2.24998 8.5758 2.24996 7.47348 2.36652 6.60651C2.48754 5.7064 2.74643 4.94853 3.34835 4.34661C3.87328 3.82168 4.51835 3.55644 5.27635 3.41721C5.83977 3.31372 6.49963 3.27425 7.26279 3.25871ZM7.26476 4.75913C6.54668 4.77447 5.99332 4.81061 5.54735 4.89253C4.98054 4.99664 4.65246 5.16382 4.40901 5.40727C4.13225 5.68403 3.9518 6.07261 3.85315 6.80638C3.75159 7.56173 3.75 8.56285 3.75 9.99826V15.9983C3.75 17.4337 3.75159 18.4348 3.85315 19.1901C3.9518 19.9239 4.13225 20.3125 4.40901 20.5893C4.68577 20.866 5.07435 21.0465 5.80812 21.1451C6.56347 21.2467 7.56458 21.2483 9 21.2483H15C16.4354 21.2483 17.4365 21.2467 18.1919 21.1451C18.9257 21.0465 19.3142 20.866 19.591 20.5893C19.8678 20.3125 20.0482 19.9239 20.1469 19.1901C20.2484 18.4348 20.25 17.4337 20.25 15.9983V9.99826C20.25 8.56285 20.2484 7.56173 20.1469 6.80638C20.0482 6.07261 19.8678 5.68403 19.591 5.40727C19.3475 5.16382 19.0195 4.99664 18.4527 4.89253C18.0067 4.81061 17.4533 4.77447 16.7352 4.75913C16.6067 5.87972 15.655 6.75 14.5 6.75H9.5C8.345 6.75 7.39326 5.87972 7.26476 4.75913ZM9.5 2.75C9.08579 2.75 8.75 3.08579 8.75 3.5V4.5C8.75 4.91421 9.08579 5.25 9.5 5.25H14.5C14.9142 5.25 15.25 4.91421 15.25 4.5V3.5C15.25 3.08579 14.9142 2.75 14.5 2.75H9.5ZM8.96967 11.5303C8.67678 11.2375 8.67678 10.7626 8.96967 10.4697C9.26256 10.1768 9.73744 10.1768 10.0303 10.4697L12 12.4394L13.9697 10.4697C14.2626 10.1768 14.7374 10.1768 15.0303 10.4697C15.3232 10.7626 15.3232 11.2375 15.0303 11.5304L13.0607 13.5L15.0303 15.4697C15.3232 15.7626 15.3232 16.2374 15.0303 16.5303C14.7374 16.8232 14.2625 16.8232 13.9697 16.5303L12 14.5607L10.0304 16.5303C9.73746 16.8232 9.26259 16.8232 8.96969 16.5304C8.6768 16.2375 8.6768 15.7626 8.96969 15.4697L10.9394 13.5L8.96967 11.5303Z" fill="#1C274C"/>
          </svg>
          <span class="sr-only">Clear data</span>
      </button>
      <div id="tooltip-copy" role="tooltip" class="absolute z-10 invisible inline-block w-auto px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700">
          Clear data
          <div class="tooltip-arrow" data-popper-arrow></div>
      </div>
  </div>
  <button type="button" 
    data-dial-toggle="speed-dial-menu-default" 
    aria-controls="speed-dial-menu-default" 
    aria-expanded="false"
    x-bind:aria-expanded="speed_dial_open"
    x-on:click="speed_dial_open = ! speed_dial_open"
    class="flex items-center justify-center text-white bg-blue-700 rounded-full w-14 h-14 hover:bg-blue-800 dark:bg-blue-600 dark:hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 focus:outline-none dark:focus:ring-blue-800"
  >
      <svg
        :class="{ 'rotate-45': speed_dial_open }"
        class="w-5 h-5 transition-transform" 
        aria-hidden="true" xmlns="http://www.w3.org/2000/svg" 
        fill="none" 
        viewBox="0 0 18 18"
      >
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
      </svg>
      <span class="sr-only">Open actions menu</span>
  </button>
</div>

<template id="forms-tabs-template-not-selected">
  <li class="mr-2">
    <a href="" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300"></a>
  </li>
</template>

<template id="forms-tabs-template-selected">
  <li class="mr-2">
    <a href="" class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 rounded-t-lg active dark:text-blue-500 dark:border-blue-500" aria-current="page"></a>
  </li>
</template>


<template id="form-data-table-template-header-cell">
  <th scope="col" class="px-6 py-4">#</th>
</template>

<template id="form-data-table-body-template-row">
  <tr class="border-b dark:border-neutral-500">
  </tr>
</template>

<template id="form-data-table-body-template-row-cell">
  <td class="whitespace-nowrap px-6 py-4">1</td>
</template>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  let formParam = urlParams.get('form');
  if(!formParam) {
    formParam = 0;
  } else {
    formParam = parseInt(formParam);
  }

  loadFormsTabs(formParam);
  loadFormDataTable(formParam);

  document.getElementById("speed-dial-menu-download-button").onclick=async() => {
    await downloadFile("/data/forms/" + formParam + "/download_excel");
  };

  document.getElementById("speed-dial-menu-clear-button").onclick=async() => {
    await deleteUrl("/data/forms/" + formParam);
    loadFormDataTable(formParam);
  };


  async function loadFormsTabs(selectedFormIndex) {
    let forms = await getJson("/data/forms")
    
    let formsTabs = document.getElementById("forms-tabs");
    formsTabs.innerHTML = '';

    let formsTabsTemplateNotSelected = document.getElementById("forms-tabs-template-not-selected");
    let formsTabsTemplateSelected = document.getElementById("forms-tabs-template-selected");
    
    let index = 0;
    for(let form of forms) {
      let clone;
      if(index === selectedFormIndex) {
        clone = formsTabsTemplateSelected.content.cloneNode(true);
      } else {
        clone = formsTabsTemplateNotSelected.content.cloneNode(true);
      }
      clone.children[0].children[0].setAttribute('href', "/forms?form=" + index);
      clone.children[0].children[0].innerHTML = form;
      formsTabs.appendChild(clone);
      index++;
    }
  }

  async function loadFormDataTable(selectedFormIndex) {
    let response = await getJson("/data/forms/" + selectedFormIndex)

    document.getElementById("form-data-table").classList.remove('hidden');
      
    let tableHeader = document.getElementById("form-data-table-header");
    tableHeader.innerHTML = '';

    let tableBody = document.getElementById("form-data-table-body");
    tableBody.innerHTML = '';

    let tableTemplateHeaderCell = document.getElementById("form-data-table-template-header-cell");
    let tableBodyTemplateRow = document.getElementById("form-data-table-body-template-row");
    let tableBodyTemplateRowCell = document.getElementById("form-data-table-body-template-row-cell");

    for (let column of response.columns) {
      const clone = tableTemplateHeaderCell.content.cloneNode(true);
      clone.children[0].innerHTML = column;
      tableHeader.appendChild(clone);
    }
    
    if(response.records.length === 0) {
      document.getElementById("form-data-table-no-data-sign").classList.remove('hidden');
    } else {
      document.getElementById("form-data-table-no-data-sign").classList.add('hidden');

      for(let record of response.records) {
        const clone1 = tableBodyTemplateRow.content.cloneNode(true);
        for ([key, value] of Object.entries(record)) {
          const clone2 = tableBodyTemplateRowCell.content.cloneNode(true);
          clone2.children[0].innerHTML = value;
          clone1.children[0].appendChild(clone2);
        }
        tableBody.appendChild(clone1);
      }
    }
  
  }

  async function getJson(url) {
    let fetchOptions = {
      method: "GET"
    };

    let res = await fetch(url, fetchOptions);

    if (!res.ok) {
        let error = await res.text();
        throw new Error(error);
    }

    return res.json();
  }

  async function deleteUrl(url) {
    let fetchOptions = {
      method: "DELETE"
    };

    let res = await fetch(url, fetchOptions);

    if (!res.ok) {
        let error = await res.text();
        throw new Error(error);
    }
  }

  async function downloadFile(url) {
    let fetchOptions = {
      method: "GET"
    };

    let res = await fetch(url, fetchOptions);

    if (!res.ok) {
        let error = await res.text();
        throw new Error(error);
    }

    const disposition = res.headers.get('Content-Disposition');
    let filename = disposition.split(/;(.+)/)[1].split(/=(.+)/)[1];
    if (filename.toLowerCase().startsWith("utf-8''"))
        filename = decodeURIComponent(filename.replace(/utf-8''/i, ''));
    else
        filename = filename.replace(/['"]/g, '');
    var url = window.URL.createObjectURL(await res.blob());
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a); // append the element to the dom
    a.click();
    a.remove(); // afterwards, remove the element
  }
</script>
</body>
</html>